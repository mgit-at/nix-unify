#!/bin/sh

set -eux

{% if deploy_with_nixos_anywhere is defined %}
env ANSIBLE_JSON={{ loc_json | quote }} {{ nix_wrapper }} nix run github:nix-community/nixos-anywhere -- --option impure "" --flake "{{ flake_dir }}#{{ flake_target }}" "{{ target_host }}"
{% else %}
env ANSIBLE_JSON={{ loc_json | quote }} {{ nix_wrapper }} nix run nixpkgs#nixos-rebuild -- --flake "{{ flake_dir }}#{{ flake_target }}" "switch" --impure --target-host "{{ target_host }}" --show-trace
{% endif %}
